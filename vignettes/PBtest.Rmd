---
title: "PBtest R Package"
author: "Yun Zhang, Xing Qiu"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
# output: pdf_document
bibliography: bibliography.bib
vignette: >
  %\VignetteIndexEntry{PBtest R Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

################################################################    
                      
# Introduction

```{r, package, message=FALSE}
## The package can be installed using the following code
# library(devtools)
# install_github("yunzhang813/PBtest-R-Package", build_vignettes=TRUE)

## Load the package
library(PBtest)
```

This R package is built for PB-transformed tests [@zhang2017highly].  In this documentation, we present a new way of conducting two-group comparison tests (think about the t-test and Wilcoxon rank-sum test) that is capable of dealing with correlation and weights in the data.  For example, multiple observations collected from the same subjects (called the "repeated measurements") are correlated, so the standard t-test and its high-throughput variations implemented in bioinformatics packages are technically not valid nor most efficient; so our method is perfect for such a situation.  An alternative approach, which is theoretically correct for such unbalanced repeated measures study design, is the linear mixed-effects regression (LMER) approach.  The downside of the LMER approach is that it is practically very slow for large-scale data, and may fail to converge.  Our proposed method is **speed efficient** (about 7,500 times faster than the LMER approach) and gives almost identical results.

Briefly, in @zhang2017highly, we derived two linear transformations, namely B-map and P-map, which transform the observed data and the two-group comparison problem to an equivalent data that are independent and identically distributed and an equivalent one-sample hypothesis testing problem, respectively. The PB-transformed data and hypotheses can then be approached by either the one-sample Student's t-test or Wilcoxon signed rank test.

################################################################

# Functions

In this vignette, we introduce two functions:

* `PBmap()` takes in `Delta` (group vector) and `Sigma` (covariance matrix), and calculates the proposed transformations.

* `PBtest()` performs the PB-transformed test with customized choices. The function takes in `XX` (data matrix), `Delta` (group vector) and `Sigma` (covariance matrix), and returns p-values for each column of the data matrix. Three implementations of test are available for the `test` option:
    + `"fast.ttest"` implements the `rowttests()` from the `genefilter` package for fast execution of t-test with large-scale data. Only two-sided test is available.
    + `"ttest"` implements `t.test()`. One-sided test is avaiable with argument `alternative` passed to the underlying function.
    + `"wilcox"` implements `wilcox.test()`. One-sided test is avaiable with argument `alternative` passed to the underlying function.

################################################################

# Examples

First, we randomly generate some data.

```{r, data-gen}
set.seed(1)
n1 <- 5; n2 <- 5; n <- n1+n2
XX <- matrix(rnorm(10000*n), nrow=n)
Delta <- rep(c(1,-1), c(n1,n2))
```

## Speed comparison of `"fast.ttest"` and `"ttest"` 

With 10,000 repetitions (e.g. genes) in the data matrix, we compare the two implementations of parametric t-test.

```{r, no-Sigma}
## By default, test="fast.ttest". 
t1 <- system.time(p1 <- PBtest(XX, Delta)) #speed efficient
t2 <- system.time(p2 <- PBtest(XX, Delta, test="ttest"))
## The p-values are numerically the same.
all.equal(p1, p2)
```

Using `"fast.ttest"` is `r round((t2/t1)[1])` times faster than using `"ttest"`; and their p-values are numerically the same.


## Equivalence to Student's t-test in default setting

By default, if `Sigma` is not given, we will use the identity matrix, i.e. assuming the observations are independent and identically distributed. In this case, our parametric test is equivalent to the Studnet's t-test. In the following chunk, we perform the two methods on the first column of observations.

```{r}
## Default setting in PB-transformed test.
PBtest(XX[,1], Delta)
## Two-sample Student's t-test.
t.test(XX[Delta==1,1], XX[Delta==-1,1], var.equal=TRUE)$p.value
```







################################################################

# Session Info

```{r, sessionInfo, echo=FALSE}
sessionInfo()
```

# References
